name: Android Release APK

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter pub get
        run: flutter pub get

      - name: Verify Android project exists
        run: |
          if [ ! -d "android" ]; then
            echo "Missing android/ directory. Run: flutter create --platforms android ."
            exit 1
          fi

      - name: Prepare Android signing files
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ] || [ -z "$ANDROID_KEY_ALIAS" ] || [ -z "$ANDROID_KEY_PASSWORD" ] || [ -z "$ANDROID_STORE_PASSWORD" ]; then
            echo "Missing Android signing secrets. Configure ANDROID_KEYSTORE_BASE64, ANDROID_KEY_ALIAS, ANDROID_KEY_PASSWORD, ANDROID_STORE_PASSWORD."
            exit 1
          fi

          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/upload-keystore.jks

          cat > android/key.properties <<EOF
          storeFile=upload-keystore.jks
          storePassword=$ANDROID_STORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_PASSWORD
          EOF

      - name: Build release APK
        run: |
          TAG="${GITHUB_REF_NAME:-v0.0.0}"
          VERSION_NAME="${TAG#v}"
          # Build number must be an integer for Android.
          VERSION_CODE="${GITHUB_RUN_NUMBER}"
          flutter build apk --release --build-name="${VERSION_NAME}" --build-number="${VERSION_CODE}"

      - name: Rename APK with version tag
        run: |
          VERSION="${GITHUB_REF_NAME:-manual}"
          cp build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/CalorieTracker-${VERSION}.apk"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: calorie-tracker-apk
          path: build/app/outputs/flutter-apk/CalorieTracker-*.apk
          if-no-files-found: error

      - name: Publish GitHub Release asset
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/CalorieTracker-*.apk
          generate_release_notes: true
